<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modern Balance Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #5B21B6, #4C1D95);
            min-height: 100vh;
            color: white;
        }

        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
        }

        .profile-icon {
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .search-bar {
            flex-grow: 1;
            margin: 0 20px;
            position: relative;
        }

        .search-bar input {
            width: 100%;
            padding: 10px 40px;
            border-radius: 20px;
            border: none;
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .search-bar input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .main-balance {
            text-align: center;
            padding: 40px 20px;
        }

        .currency-label {
            font-size: 18px;
            opacity: 0.8;
            margin-bottom: 10px;
        }

        .balance-amount {
            font-size: 48px;
            font-weight: bold;
            margin-bottom: 20px;
        }

        .action-buttons {
            display: flex;
            justify-content: space-around;
            padding: 20px;
            margin-bottom: 20px;
        }

        .transactions-card {
            background: white;
            border-radius: 20px 20px 0 0;
            padding: 20px;
            margin-top: 20px;
            min-height: 300px;
            color: #333;
           /* Remove bottom margin since nav bar is gone */
        }

        .confirm-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1001;
            max-width: 90%;
            width: 300px;
            text-align: center;
        }

        .confirm-modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .confirm-modal h3 {
            margin: 0 0 15px 0;
            color: #333;
        }

        .confirm-modal p {
            margin: 0 0 20px 0;
            color: #666;
        }

        .confirm-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .confirm-button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
        }

        .confirm-yes {
            background: #5B21B6;
            color: white;
        }

        .confirm-no {
            background: #DC2626;
            color: white;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 20px;
            width: 90%;
            max-width: 400px;
            color: #333;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #666;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
        }

        .modal-button {
            width: 100%;
            padding: 12px;
            background: #5B21B6;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 10px;
        }

        .transaction-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
        }

        .transaction-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        .transaction-amount {
            font-weight: bold;
        }

        .transaction-amount.negative {
            color: #DC2626;
        }

        .reward-amount {
            color: #059669;
            font-size: 12px;
            margin-top: 4px;
        }

        .transaction-date {
            font-size: 12px;
            color: #666;
        }

        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 15px 25px;
            border-radius: 10px;
            background-color: white;
            color: #333;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            display: none;
        }

        .profile-icon {
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            cursor: pointer;
        }

        .search-bar {
            flex-grow: 1;
            margin: 0 20px;
            position: relative;
        }

        .search-bar input {
            width: 100%;
            padding: 10px 40px;
            border-radius: 20px;
            border: none;
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .search-bar input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .main-balance {
            text-align: center;
            padding: 40px 20px;
        }

        .currency-label {
            font-size: 18px;
            opacity: 0.8;
            margin-bottom: 10px;
        }

        .balance-amount {
            font-size: 48px;
            font-weight: bold;
            margin-bottom: 20px;
        }


        .action-button {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: white;
            text-decoration: none;
            background: none;
            border: none;
            cursor: pointer;
        }

        .action-icon {
            width: 50px;
            height: 50px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 8px;
            font-size: 24px;
        }

        .transactions-card {
            background: white;
            border-radius: 20px 20px 0 0;
            padding: 20px;
            margin-top: 20px;
            min-height: 300px;
            color: #333;
        }

        .chart-container {
            width: 100%;
            height: 300px;
            margin-top: 20px;
            background: white;
            padding: 20px;
            border-radius: 10px;
        }

        .profile-modal {
            background: white;
            color: #333;
            padding: 20px;
            border-radius: 10px;
        }

        .profile-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .rankings-container {
            background: white;
            color: #333;
            padding: 20px;
            border-radius: 10px;
            max-height: 80vh; /* Set maximum height to 80% of viewport height */
            display: flex;
            flex-direction: column;
        }

        .rankings-title {
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
            font-size: 1.25rem;
            font-weight: bold;
            position: sticky;
            top: 0;
            background: white;
        }

        .rankings-scroll {
            overflow-y: auto;
            flex-grow: 1;
            margin: 0 -20px; /* Extend to edges */
            padding: 0 20px; /* Restore padding */
            /* Add smooth scrollbar for webkit browsers */
            scrollbar-width: thin;
            scrollbar-color: #5B21B6 #eee;
        }

        .rankings-scroll::-webkit-scrollbar {
            width: 8px;
        }

        .rankings-scroll::-webkit-scrollbar-track {
            background: #eee;
            border-radius: 4px;
        }

        .rankings-scroll::-webkit-scrollbar-thumb {
            background: #5B21B6;
            border-radius: 4px;
        }

        .ranking-item {
            display: flex;
            justify-content: space-between;
            padding: 15px 0;
            border-bottom: 1px solid #eee;
        }

        .ranking-position {
            font-weight: bold;
            color: #5B21B6;
            margin-right: 10px;
        }

        .ranking-details {
            text-align: right;
        }

        .ranking-total {
            font-weight: bold;
            color: #333;
        }

        .ranking-count {
            font-size: 0.9rem;
            color: #666;
            margin-top: 4px;
        }

        .rankings-footer {
            margin-top: 20px;
            padding-top: 10px;
            border-top: 1px solid #eee;
            position: sticky;
            bottom: 0;
            background: white;
        }
    </style>
</head>
<body>
    <div class="top-bar">
        <div class="profile-icon" onclick="showProfileModal()">JS</div>
        <div class="search-bar">
            <input type="text" id="searchInput" placeholder="Search transactions..." onkeyup="searchTransactions()">
        </div>
    </div>

    <div class="main-balance">
        <div class="currency-label">Main · PHP</div>
        <div class="balance-amount" id="currentBalance">₱0.00</div>
    </div>

    <div class="action-buttons">
        <button class="action-button" onclick="showAddMoneyModal()">
            <div class="action-icon">+</div>
            <span>Add money</span>
        </button>
        <button class="action-button" onclick="resetBalance()">
            <div class="action-icon">↻</div>
            <span>Reset</span>
        </button>
        <button class="action-button" onclick="showTransactionModal()">
            <div class="action-icon">↔</div>
            <span>Transaction</span>
        </button>
        <button class="action-button" onclick="showDetails()">
            <div class="action-icon">≡</div>
            <span>Details</span>
        </button>
        <button class="action-button" onclick="showRankings()">
            <div class="action-icon">🏆</div>
            <span>Rankings</span>
        </button>
    </div>

    <div class="transactions-card" id="transactionsList">
        <div style="text-align: center; color: #666;">No transactions yet</div>
    </div>

    <!-- Add Money Modal -->
    <div id="addMoneyModal" class="modal">
        <div class="modal-content">
            <h2 style="margin-bottom: 20px;">Set Initial Balance</h2>
            <div class="form-group">
                <label>Amount</label>
                <input type="number" id="initialBalance" placeholder="Enter amount">
            </div>
            <button class="modal-button" onclick="setInitialBalance()">Set Balance</button>
            <button class="modal-button" style="background: #DC2626;" onclick="closeModal('addMoneyModal')">Cancel</button>
        </div>
    </div>

    <!-- Transaction Modal -->
    <div id="transactionModal" class="modal">
        <div class="modal-content">
            <h2 style="margin-bottom: 20px;">New Transaction</h2>
            <div class="form-group">
                <label>Buyer Name</label>
                <input type="text" id="buyerName" placeholder="Enter buyer name">
            </div>
            <div class="form-group">
                <label>Amount</label>
                <input type="number" id="amount" placeholder="Enter amount">
            </div>
            <div class="form-group">
                <label>Transaction Type</label>
                <select id="transactionType">
                    <option value="paid">Paid</option>
                    <option value="borrowed">Borrowed</option>
                </select>
            </div>
            <button class="modal-button" onclick="addTransaction()">Add Transaction</button>
            <button class="modal-button" style="background: #DC2626;" onclick="closeModal('transactionModal')">Cancel</button>
        </div>
    </div>
    <div id="profileModal" class="modal">
        <div class="modal-content profile-modal">
            <h2 style="margin-bottom: 20px;">Profile Settings</h2>
            <div class="profile-form">
                <div class="form-group">
                    <label>Name</label>
                    <input type="text" id="profileName" placeholder="Enter your name">
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="profileEmail" placeholder="Enter your email">
                </div>
                <button class="modal-button" onclick="saveProfile()">Save Profile</button>
                <button class="modal-button" style="background: #DC2626;" onclick="closeModal('profileModal')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Rankings Modal -->
    <div id="rankingsModal" class="modal">
        <div class="modal-content rankings-container">
            <h2 class="rankings-title">Transaction Rankings</h2>
            <div class="rankings-scroll" id="rankingsList"></div>
            <div class="rankings-footer">
                <button class="modal-button" onclick="closeModal('rankingsModal')">Close</button>
            </div>
        </div>
    </div>

    <div id="confirmationModal" style="display: none;">
        <div class="confirm-modal-backdrop"></div>
        <div class="confirm-modal">
            <h3 id="confirmTitle"></h3>
            <p id="confirmMessage"></p>
            <div class="confirm-buttons">
                <button class="confirm-button confirm-yes" id="confirmYes">Yes</button>
                <button class="confirm-button confirm-no" id="confirmNo">No</button>
            </div>
        </div>
    </div>

    <div class="notification" id="notification"></div>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>

        // Your existing JavaScript code here, just update the UI-related functions
        let currentBalance = 0;
        let transactions = [];
        let historicalTransactions = [];

        function roundToTwoDecimals(number) {
            return Math.floor(number * 100) / 100;
        }

        function showAddMoneyModal() {
            document.getElementById('addMoneyModal').style.display = 'flex';
        }

        function showTransactionModal() {
            document.getElementById('transactionModal').style.display = 'flex';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function showNotification(message, type = 'error') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.style.display = 'block';
            notification.style.backgroundColor = type === 'error' ? '#FEE2E2' : '#D1FAE5';
            notification.style.color = type === 'error' ? '#DC2626' : '#059669';

            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }

        function formatCurrency(amount) {
            return '₱' + amount.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }

        function updateBalanceDisplay() {
            document.getElementById('currentBalance').textContent = formatCurrency(currentBalance);
        }


        function showConfirmation(title, message, onConfirm) {
            const modal = document.getElementById('confirmationModal');
            const titleEl = document.getElementById('confirmTitle');
            const messageEl = document.getElementById('confirmMessage');
            const yesBtn = document.getElementById('confirmYes');
            const noBtn = document.getElementById('confirmNo');

            titleEl.textContent = title;
            messageEl.textContent = message;
            modal.style.display = 'block';

            yesBtn.onclick = () => {
                modal.style.display = 'none';
                onConfirm();
            };

            noBtn.onclick = () => {
                modal.style.display = 'none';
            };

            // Close on backdrop click
            modal.querySelector('.confirm-modal-backdrop').onclick = () => {
                modal.style.display = 'none';
            };
        }


        function setInitialBalance() {
    const amount = parseFloat(document.getElementById('initialBalance').value);
    
    if (isNaN(amount) || amount < 0) {
        showNotification('Please enter a valid amount', 'error');
        return;
    }

    // Get active borrowed transactions
    const activeBorrowed = getActiveBorrowedTransactions();
    
    // Calculate total borrowed amount
    const totalBorrowed = activeBorrowed.reduce((sum, t) => sum + t.remainingAmount, 0);
    
    // Check if new balance can cover borrowed amounts
    if (amount < totalBorrowed) {
        showNotification(
            `New balance must be at least ${formatCurrency(totalBorrowed)} to cover existing borrowed amounts`,
            'error'
        );
        return;
    }

    // If there's already a balance, show confirmation dialog
    if (currentBalance > 0) {
        showConfirmation(
            'Confirm New Balance',
            `Are you sure you want to set a new balance of ${formatCurrency(amount)}? Current transactions will be archived.`,
            () => {
                // Save non-borrowed transactions to history
                if (transactions.length > 0) {
                    const nonBorrowedTransactions = transactions.filter(t => 
                        t.type !== 'borrowed' || t.remainingAmount === 0
                    );
                    
                    if (nonBorrowedTransactions.length > 0) {
                        const currentBatch = {
                            date: new Date().toLocaleString(),
                            initialBalance: currentBalance,
                            transactions: nonBorrowedTransactions
                        };
                        historicalTransactions.unshift(currentBatch);
                    }
                }
                
                // Keep active borrowed transactions
                transactions = activeBorrowed;
                currentBalance = amount;
                updateBalanceDisplay();
                document.getElementById('initialBalance').value = '';
                closeModal('addMoneyModal');
                
                if (activeBorrowed.length > 0) {
                    showNotification(
                        `New balance set with ${activeBorrowed.length} borrowed transaction(s) retained`,
                        'success'
                    );
                } else {
                    showNotification('Balance set successfully', 'success');
                }
                
                updateTransactionsList();
                saveData();
            }
        );
    } else {
        showConfirmation(
            'Confirm Initial Balance',
            `Are you sure you want to set an initial balance of ${formatCurrency(amount)}?`,
            () => {
                // Keep active borrowed transactions
                transactions = activeBorrowed;
                currentBalance = amount;
                updateBalanceDisplay();
                document.getElementById('initialBalance').value = '';
                closeModal('addMoneyModal');
                
                if (activeBorrowed.length > 0) {
                    showNotification(
                        `Initial balance set with ${activeBorrowed.length} borrowed transaction(s) retained`,
                        'success'
                    );
                } else {
                    showNotification('Initial balance set successfully', 'success');
                }
                
                updateTransactionsList();
                saveData();
            }
        );
    }
}

        function resetBalance() {
    showConfirmation(
        'Confirm Reset',
        'Are you sure you want to reset your balance? Current transactions will be archived.',
        () => {
            showConfirmation(
                'Final Confirmation',
                'This action cannot be undone. Do you really want to proceed?',
                () => {
                    // Get active borrowed transactions before reset
                    const activeBorrowed = getActiveBorrowedTransactions();
                    
                    // Save non-borrowed transactions to historical transactions
                    if (transactions.length > 0) {
                        const nonBorrowedTransactions = transactions.filter(t => 
                            t.type !== 'borrowed' || t.remainingAmount === 0
                        );
                        
                        if (nonBorrowedTransactions.length > 0) {
                            const currentBatch = {
                                date: new Date().toLocaleString(),
                                initialBalance: currentBalance,
                                transactions: nonBorrowedTransactions
                            };
                            historicalTransactions.unshift(currentBatch);
                        }
                    }

                    // Reset current balance
                    currentBalance = 0;
                    
                    // Clear current transactions but keep active borrowed ones
                    transactions = activeBorrowed;

                    // Update UI
                    updateBalanceDisplay();
                    updateTransactionsList();
                    saveData();
                    showNotification('Balance has been reset successfully', 'success');

                    // If there are active borrowed transactions, show a notification
                    if (activeBorrowed.length > 0) {
                        showNotification(
                            `${activeBorrowed.length} borrowed transaction(s) retained`,
                            'success'
                        );
                    }

                    // Ask if they want to set new balance
                    showConfirmation(
                        'Set New Balance',
                        'Would you like to set a new balance now?',
                        () => {
                            showAddMoneyModal();
                        }
                    );
                }
            );
        }
    );
}


function makePayment() {
    const transactionIndex = parseInt(document.getElementById('currentTransactionIndex').value);
    const paymentAmount = parseFloat(document.getElementById('paymentAmount').value);
    const transaction = transactions[transactionIndex];

    if (isNaN(paymentAmount) || paymentAmount <= 0) {
        showNotification('Please enter a valid payment amount', 'error');
        return;
    }

    if (paymentAmount > transaction.remainingAmount) {
        showNotification('Payment amount cannot exceed remaining balance', 'error');
        return;
    }

    // Update the transaction
    transaction.remainingAmount -= paymentAmount;
    
    // If fully paid, update the type
    if (transaction.remainingAmount === 0) {
        transaction.type = 'paid';
        transaction.fullyPaidDate = new Date().toLocaleString();
    }

    // Add payment to the transaction's payment history if it doesn't exist
    if (!transaction.payments) {
        transaction.payments = [];
    }
    
    transaction.payments.push({
        amount: paymentAmount,
        date: new Date().toLocaleString()
    });

    // Update UI and save
    updateTransactionsList();
    saveData();
    closeModal('paymentModal');
    showNotification('Payment recorded successfully', 'success');
}

function addTransaction() {
            const buyerName = document.getElementById('buyerName').value.trim();
            const amount = parseFloat(document.getElementById('amount').value);
            const type = document.getElementById('transactionType').value;

            if (!buyerName) {
                showNotification('Please enter a buyer name', 'error');
                return;
            }

            if (isNaN(amount) || amount <= 0) {
                showNotification('Please enter a valid amount', 'error');
                return;
            }

            // Check if transaction amount exceeds current balance
            if (amount > currentBalance) {
                showNotification(`Insufficient balance. Current balance: ${formatCurrency(currentBalance)}`, 'error');
                return;
            }

            // Calculate 0.5% reward
            const reward = Math.floor(amount * 0.005 * 100) / 100;

            const transaction = {
                buyerName,
                amount,
                reward,
                date: new Date().toLocaleString(),
                type,
                remainingAmount: type === 'borrowed' ? amount : 0
            };

            transactions.unshift(transaction);
            // Subtract amount but add reward
            currentBalance = currentBalance - amount + reward;
            updateBalanceDisplay();
            updateTransactionsList();
            closeModal('transactionModal');
            
            document.getElementById('buyerName').value = '';
            document.getElementById('amount').value = '';
            document.getElementById('transactionType').selectedIndex = 0;
            
            showNotification('Transaction added successfully', 'success');
            saveData();
        }

        function getActiveBorrowedTransactions() {
    // Get borrowed transactions from current transactions
    const currentBorrowed = transactions.filter(t => 
        t.type === 'borrowed' && t.remainingAmount > 0
    );
    
    // Get borrowed transactions from historical transactions
    const historicalBorrowed = historicalTransactions.flatMap(batch => 
        batch.transactions.filter(t => 
            t.type === 'borrowed' && t.remainingAmount > 0
        )
    );
    
    return [...currentBorrowed, ...historicalBorrowed];
}


        function updateTransactionsList(filteredTransactions = transactions) {
    const transactionsList = document.getElementById('transactionsList');
    
    if (filteredTransactions.length === 0) {
        transactionsList.innerHTML = '<div style="text-align: center; color: #666;">No transactions yet</div>';
        return;
    }

    transactionsList.innerHTML = filteredTransactions.map((transaction, index) => `
        <div class="transaction-item">
            <div class="transaction-header">
                <div>${transaction.buyerName}</div>
                <div>
                    <div class="transaction-amount negative">-${formatCurrency(transaction.amount)}</div>
                    <div class="reward-amount">+${formatCurrency(transaction.reward)} (0.5% reward)</div>
                </div>
            </div>
            <div class="transaction-date">${transaction.date}</div>
            <div style="color: ${transaction.type === 'paid' ? '#059669' : '#DC2626'}">
                ${transaction.type === 'paid' ? 'Paid' : 'Borrowed'}
            </div>
            ${transaction.type === 'borrowed' && transaction.remainingAmount > 0 ? `
                <div style="margin-top: 10px;">
                    <div>Remaining: ${formatCurrency(transaction.remainingAmount)}</div>
                    <button 
                        class="modal-button" 
                        style="margin-top: 5px; padding: 5px;"
                        onclick="showPaymentModal(${index})"
                    >
                        Make Payment
                    </button>
                </div>
            ` : ''}
        </div>
    `).join('');
}

// Add payment modal HTML after your existing modals
const paymentModal = `
<div id="paymentModal" class="modal">
    <div class="modal-content">
        <h2 style="margin-bottom: 20px;">Make Payment</h2>
        <div class="form-group">
            <label>Payment Amount</label>
            <input type="number" id="paymentAmount" placeholder="Enter payment amount">
        </div>
        <input type="hidden" id="currentTransactionIndex">
        <button class="modal-button" onclick="makePayment()">Submit Payment</button>
        <button class="modal-button" style="background: #DC2626;" onclick="closeModal('paymentModal')">Cancel</button>
    </div>
</div>
`;

// Add this to your HTML body
document.body.insertAdjacentHTML('beforeend', paymentModal);

function showPaymentModal(transactionIndex) {
    const transaction = transactions[transactionIndex];
    document.getElementById('currentTransactionIndex').value = transactionIndex;
    document.getElementById('paymentAmount').value = transaction.remainingAmount;
    document.getElementById('paymentModal').style.display = 'flex';
}

        function saveData() {
            localStorage.setItem('balanceTrackerData', JSON.stringify({
                currentBalance,
                transactions,
                historicalTransactions
            }));
        }

        function loadData() {
            const savedData = localStorage.getItem('balanceTrackerData');
            if (savedData) {
                const data = JSON.parse(savedData);
                currentBalance = data.currentBalance || 0;
                transactions = data.transactions || [];
                historicalTransactions = data.historicalTransactions || [];
                updateBalanceDisplay();
                updateTransactionsList();
            }
            
            // Check if balance is set
            if (currentBalance === 0 && transactions.length === 0) {
                if (confirm('Would you like to set your initial balance?')) {
                    showAddMoneyModal();
                }
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', loadData);

        // Close modals when clicking outside
        window.onclick = function(event) {
            if (event.target.className === 'modal') {
                event.target.style.display = 'none';
            }
        }
        function deleteBatch(groupIndex) {
            if (confirm('Are you sure you want to delete this batch? This action cannot be undone.')) {
                historicalTransactions.splice(groupIndex, 1);
                updateTransactionHistory();
                saveData();
                showNotification('Batch deleted successfully', 'success');
            }
        }

        function updateTransactionHistory() {
            const historyContainer = document.getElementById('transactionHistory');
            
            if (historicalTransactions.length === 0) {
                historyContainer.innerHTML = '<div class="no-transactions">No historical transactions</div>';
                return;
            }

            historyContainer.innerHTML = historicalTransactions.map((group, groupIndex) => {
                const hasBorrowedTransactions = group.transactions.some(t => 
                    t.type === 'borrowed' && t.remainingAmount > 0
                );

                return `
                    <div class="history-group">
                        <div class="history-header">
                            <span>Session: ${group.date}</span>
                            <div class="button-group">
                                ${hasBorrowedTransactions ? 
                                    '<span style="color: #d93025; margin-right: 10px;">Unpaid Balance!</span>' : ''}
                                <button class="delete-button" onclick="deleteBatch(${groupIndex})">Delete Batch</button>
                                ${hasBorrowedTransactions ? 
                                    `<button class="complete-button" onclick="completeHistoricalPayments(${groupIndex})">
                                        Complete All Payments
                                    </button>` : ''}
                            </div>
                        </div>
                        <div class="history-balance">Initial Balance: ${formatCurrency(group.initialBalance)}</div>
                        ${group.transactions.map(transaction => `
                            <div class="transaction-item">
                                <div class="transaction-main">
                                    <div class="transaction-info">
                                        <div>${transaction.buyerName}</div>
                                        <div class="transaction-date">${transaction.date}</div>
                                    </div>
                                    <div class="transaction-amount">
                                        -${formatCurrency(transaction.amount)}
                                        ${transaction.reward ? 
                                            `<div style="color: #34a853; font-size: 12px;">
                                                +${formatCurrency(transaction.reward)} (0.5% reward)
                                            </div>` : ''}
                                    </div>
                                </div>
                                <div class="transaction-status ${transaction.type === 'paid' ? 'status-paid' : 'status-borrowed'}">
                                    ${transaction.type === 'paid' ? 
                                        `Paid ${transaction.fullyPaidDate ? `on ${transaction.fullyPaidDate}` : ''}` : 
                                        'Borrowed'}
                                </div>
                                ${transaction.type === 'borrowed' ? `
                                    <div class="remaining-amount">
                                        Final Remaining: ${formatCurrency(transaction.remainingAmount)}
                                    </div>
                                    ${transaction.payments.map(payment => `
                                        <div class="transaction-date">
                                            Payment: ${formatCurrency(payment.amount)} on ${payment.date}
                                        </div>
                                    `).join('')}
                                ` : ''}
                            </div>
                        `).join('')}
                    </div>
                `;
            }).join('');
        }

        function updateOnlineStatus() {
            const indicator = document.getElementById('offlineIndicator');
            if (!indicator) return;
            
            if (navigator.onLine) {
                indicator.textContent = 'Online';
                indicator.className = 'offline-indicator online';
            } else {
                indicator.textContent = 'Offline (App still working)';
                indicator.className = 'offline-indicator offline';
            }
        }

        function validateAndRepairData() {
            transactions = transactions.map(transaction => {
                if (transaction.remainingAmount === 0) {
                    return {
                        ...transaction,
                        type: 'paid'
                    };
                }
                return transaction;
            });

            historicalTransactions = historicalTransactions.map(group => ({
                ...group,
                transactions: group.transactions.map(transaction => {
                    if (transaction.remainingAmount === 0) {
                        return {
                            ...transaction,
                            type: 'paid'
                        };
                    }
                    return transaction;
                })
            }));

            saveData();
        }

        let userProfile = {
            name: '',
            email: ''
        };

        function showProfileModal() {
            document.getElementById('profileModal').style.display = 'flex';
            document.getElementById('profileName').value = userProfile.name;
            document.getElementById('profileEmail').value = userProfile.email;
        }

        function saveProfile() {
            userProfile.name = document.getElementById('profileName').value;
            userProfile.email = document.getElementById('profileEmail').value;
            localStorage.setItem('userProfile', JSON.stringify(userProfile));
            closeModal('profileModal');
            showNotification('Profile saved successfully', 'success');
            updateProfileIcon();
        }

        function updateProfileIcon() {
            const initials = userProfile.name ? userProfile.name.split(' ').map(n => n[0]).join('').toUpperCase() : 'JS';
            document.querySelector('.profile-icon').textContent = initials;
        }

        function searchTransactions() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const filteredTransactions = transactions.filter(t => 
                t.buyerName.toLowerCase().includes(searchTerm)
            );
            updateTransactionsList(filteredTransactions);
        }

       
        function showRankings() {
            // Combine current and historical transactions
            const allTransactions = [
                ...transactions,
                ...historicalTransactions.flatMap(batch => batch.transactions)
            ];

            const rankings = allTransactions.reduce((acc, t) => {
                if (!acc[t.buyerName]) {
                    acc[t.buyerName] = {
                        total: 0,
                        count: 0
                    };
                }
                acc[t.buyerName].total += t.amount;
                acc[t.buyerName].count += 1;
                return acc;
            }, {});

            const rankingsList = Object.entries(rankings)
                .sort((a, b) => b[1].total - a[1].total)
                .map(([name, stats]) => ({
                    name,
                    total: stats.total,
                    count: stats.count
                }));

            document.getElementById('rankingsList').innerHTML = rankingsList
                .map((item, index) => `
                    <div class="ranking-item">
                        <div>
                            <span class="ranking-position">#${index + 1}</span>
                            <span>${item.name}</span>
                        </div>
                        <div class="ranking-details">
                            <div class="ranking-total">${formatCurrency(item.total)}</div>
                            <div class="ranking-count">${item.count} transaction${item.count !== 1 ? 's' : ''}</div>
                        </div>
                    </div>
                `).join('');

            document.getElementById('rankingsModal').style.display = 'flex';
        }

        

        function showDetails() {
            // Combine current and historical transactions
            const allTransactions = [
                ...transactions,
                ...historicalTransactions.flatMap(batch => batch.transactions)
            ].sort((a, b) => new Date(a.date) - new Date(b.date));

            const chartData = {
                labels: allTransactions.map(t => new Date(t.date).toLocaleDateString()),
                datasets: [{
                    label: 'Transaction Amount',
                    data: allTransactions.map(t => t.amount),
                    borderColor: '#5B21B6',
                    fill: false
                }]
            };

            const chartContainer = document.createElement('div');
            chartContainer.className = 'chart-container';
            chartContainer.innerHTML = '<canvas id="transactionChart"></canvas>';
            
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'flex';
            
            const modalContent = document.createElement('div');
            modalContent.className = 'modal-content';
            modalContent.style.width = '90%';
            modalContent.style.maxWidth = '800px';
            
            // Add total statistics
            const stats = allTransactions.reduce((acc, t) => {
                acc.totalAmount += t.amount;
                acc.totalReward += t.reward || 0;
                return acc;
            }, { totalAmount: 0, totalReward: 0 });
            
            const statsHtml = `
                <div style="margin-bottom: 20px; padding: 15px; background: #f3f4f6; border-radius: 8px;">
                    <h3 style="margin-bottom: 10px;">All-Time Statistics</h3>
                    <div>Total Transactions: ${allTransactions.length}</div>
                    <div>Total Amount: ${formatCurrency(stats.totalAmount)}</div>
                    <div>Total Rewards: ${formatCurrency(stats.totalReward)}</div>
                </div>
            `;
            
            modalContent.innerHTML = statsHtml;
            modalContent.appendChild(chartContainer);

            const closeButton = document.createElement('button');
            closeButton.className = 'modal-button';
            closeButton.style.marginTop = '20px';
            closeButton.textContent = 'Close';
            closeButton.onclick = () => modal.remove();
            modalContent.appendChild(closeButton);

            modal.appendChild(modalContent);
            document.body.appendChild(modal);

            new Chart(document.getElementById('transactionChart'), {
                type: 'line',
                data: chartData,
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        // Load profile on startup
        function loadProfile() {
            const savedProfile = localStorage.getItem('userProfile');
            if (savedProfile) {
                userProfile = JSON.parse(savedProfile);
                updateProfileIcon();
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            loadProfile();
        }); 

        document.addEventListener('DOMContentLoaded', loadData);
    </script>
</body>
</html>
